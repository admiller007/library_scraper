<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicago Library Events</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        .checkbox-container {
            max-height: 150px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        .checkbox-container::-webkit-scrollbar {
            width: 6px;
        }
        .checkbox-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .checkbox-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark min-h-screen">
    <div class="relative flex h-auto min-h-screen w-full flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-10 flex items-center justify-between border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-background-dark/80 backdrop-blur-sm px-6 py-4">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-primary text-2xl">local_library</span>
                <div>
                    <h1 class="text-slate-800 dark:text-slate-200 text-xl font-bold">Chicago Library Events</h1>
                    <p class="text-slate-600 dark:text-slate-400 text-sm">
                        Total Events: {{ total_events }}
                        {% if csv_file %}• Loaded from: {{ csv_file }}{% endif %}
                    </p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadICS()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                    <span class="material-symbols-outlined text-lg">calendar_month</span>
                    Download ICS
                </button>
                <button onclick="downloadPDF()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors">
                    <span class="material-symbols-outlined text-lg">picture_as_pdf</span>
                    Download PDF
                </button>
                <button onclick="refreshData()"
                        id="refresh-btn"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg font-medium transition-colors">
                    <span class="material-symbols-outlined text-lg">refresh</span>
                    Refresh Data
                </button>
            </div>
        </header>

        <!-- Filters Section -->
        <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-6 py-4">
            <div class="grid grid-cols-1 lg:grid-cols-4 xl:grid-cols-6 gap-4 items-end">
                <!-- Library Filter -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Libraries</label>
                    <div class="border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 p-3 checkbox-container">
                        <label class="flex items-center text-sm text-slate-700 dark:text-slate-300 mb-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 px-2 py-1 rounded">
                            <input type="checkbox" id="library-all" name="library" value="All"
                                   class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary mr-2" checked>
                            <span class="truncate font-medium">All Libraries</span>
                        </label>
                        {% if libraries %}
                            {% for library in libraries %}
                            <label class="flex items-center text-sm text-slate-700 dark:text-slate-300 mb-2 last:mb-0 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 px-2 py-1 rounded">
                                <input type="checkbox" name="library" value="{{ library }}"
                                       class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary mr-2">
                                <span class="truncate">{{ library }}</span>
                            </label>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Age Group Filter -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Age Groups</label>
                    <div class="border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 p-3 checkbox-container">
                        {% if types %}
                            {% for t in types %}
                            <label class="flex items-center text-sm text-slate-700 dark:text-slate-300 mb-2 last:mb-0 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 px-2 py-1 rounded">
                                <input type="checkbox" name="type" value="{{ t }}"
                                       class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary mr-2">
                                <span class="truncate">{{ t }}</span>
                            </label>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Search -->
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-lg">search</span>
                            <input type="text" id="search-input" placeholder="Search events..."
                                   class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search Mode</label>
                            <select id="search-mode"
                                    class="w-full px-3 py-2 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="any" selected>Any word</option>
                                <option value="all">All words</option>
                                <option value="exact">Exact phrase</option>
                                <option value="fuzzy">Fuzzy match</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Fields</label>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                    <input type="checkbox" name="search-field" value="title" class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary" checked>
                                    <span>Title</span>
                                </label>
                                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                    <input type="checkbox" name="search-field" value="description" class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary" checked>
                                    <span>Description</span>
                                </label>
                                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                    <input type="checkbox" name="search-field" value="location" class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary" checked>
                                    <span>Location</span>
                                </label>
                                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                    <input type="checkbox" name="search-field" value="library" class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary">
                                    <span>Library</span>
                                </label>
                                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                    <input type="checkbox" name="search-field" value="age_group" class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary">
                                    <span>Age Group</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Preset -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Date Range</label>
                    <select id="date-preset"
                            class="w-full px-3 py-2 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary">
                        <option value="all">All Dates</option>
                        <option value="today">Today</option>
                        <option value="tomorrow">Tomorrow</option>
                        <option value="next7">Next 7 Days</option>
                        <option value="next14">Next 14 Days</option>
                        <option value="thisweek">This Week</option>
                        <option value="weekend">This Weekend</option>
                        <option value="thismonth">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <!-- Custom Date Range (Hidden by default) -->
                <div id="custom-date-range" class="hidden col-span-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Start Date</label>
                            <input type="date" id="start-date"
                                   {% if min_date %}min="{{ min_date }}"{% endif %}
                                   {% if max_date %}max="{{ max_date }}"{% endif %}
                                   class="w-full px-3 py-2 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">End Date</label>
                            <input type="date" id="end-date"
                                   {% if min_date %}min="{{ min_date }}"{% endif %}
                                   {% if max_date %}max="{{ max_date }}"{% endif %}
                                   class="w-full px-3 py-2 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                </div>

                <!-- Apply Filters Button -->
                <div class="lg:col-span-1">
                    <button onclick="applyFilters()"
                            class="w-full px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg font-medium transition-colors inline-flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">filter_list</span>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Scrape Progress -->
        <section class="px-6 py-4 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm font-semibold text-slate-800 dark:text-slate-200">Scrape Progress</p>
                    <p id="progress-meta" class="text-xs text-slate-500 dark:text-slate-400">Idle</p>
                </div>
                <button onclick="fetchProgress(true)"
                        class="inline-flex items-center gap-2 px-3 py-2 text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined text-base">sync</span>
                    Sync Progress
                </button>
            </div>
            <div id="progress-summary" class="flex flex-wrap gap-3 text-sm text-slate-700 dark:text-slate-300">
                <span class="text-xs text-slate-500">Waiting for a run...</span>
            </div>
            <div id="progress-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 mt-3"></div>
        </section>

        <!-- Events Grid -->
        <main class="flex-1 p-6">
            <div id="events-grid" class="grid gap-6 grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-slate-600 dark:text-slate-400">Loading events...</p>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <footer class="border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 px-6 py-3">
            <div class="flex items-center justify-between">
                <span id="status" class="text-sm text-slate-600 dark:text-slate-400">Ready</span>
                <div class="text-xs text-slate-500 dark:text-slate-500">
                    Last updated: <span id="last-updated">Loading...</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        let allEvents = [];
        let filteredEvents = [];
        let progressInterval = null;
        let awaitingRefreshData = false;
        let lastProgressState = 'idle';
        let lastEventsTotal = 0;
        let lastDataLoadTs = null;

        // Load events on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize preset to Today if within bounds
            const preset = document.getElementById('date-preset');
            const startInput = document.getElementById('start-date');
            const endInput = document.getElementById('end-date');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayIso = `${yyyy}-${mm}-${dd}`;
            const min = startInput ? startInput.getAttribute('min') : null;
            const max = endInput ? endInput.getAttribute('max') : null;
            if ((!min || todayIso >= min) && (!max || todayIso <= max)) {
                preset.value = 'today';
            } else {
                preset.value = 'all';
            }

            // Toggle custom range UI
            preset.addEventListener('change', function() {
                const show = preset.value === 'custom';
                const customRange = document.getElementById('custom-date-range');
                if (show) {
                    customRange.classList.remove('hidden');
                } else {
                    customRange.classList.add('hidden');
                }
            });

            loadEvents().then(() => applyFilters());
            fetchProgress();

            // Add enter key support for search
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // Handle "All Libraries" checkbox behavior
            const allLibrariesCheckbox = document.getElementById('library-all');
            const libraryCheckboxes = document.querySelectorAll('input[name="library"]:not(#library-all)');

            if (allLibrariesCheckbox) {
                allLibrariesCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        libraryCheckboxes.forEach(cb => cb.checked = false);
                    }
                });
            }

            libraryCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked && allLibrariesCheckbox) {
                        allLibrariesCheckbox.checked = false;
                    }
                    // If no libraries are selected, check "All Libraries"
                    const anyChecked = Array.from(libraryCheckboxes).some(checkbox => checkbox.checked);
                    if (!anyChecked && allLibrariesCheckbox) {
                        allLibrariesCheckbox.checked = true;
                    }
                });
            });

            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        });

        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                const data = await response.json();
                allEvents = data.events;
                lastEventsTotal = data.total;
                lastDataLoadTs = Date.now();
                displayEvents(allEvents);
                updateStatus(`Showing ${data.total} events`);
            } catch (error) {
                document.getElementById('events-grid').innerHTML =
                    `<div class="col-span-full text-center py-12">
                        <span class="material-symbols-outlined text-4xl text-red-500 mb-4 block">error</span>
                        <p class="text-slate-600 dark:text-slate-400">Error loading events: ${error.message}</p>
                    </div>`;
                updateStatus('Error loading events');
            }
        }

        async function applyFilters() {
            const libraryCheckboxes = Array.from(document.querySelectorAll('input[name="library"]:checked'));
            const librarySelected = libraryCheckboxes
                .filter(cb => cb.value !== 'All')
                .map(cb => cb.value);
            const typeSelected = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => cb.value);
            const search = document.getElementById('search-input').value;
            const searchMode = document.getElementById('search-mode').value;
            const searchFields = Array.from(document.querySelectorAll('input[name="search-field"]:checked')).map(cb => cb.value);
            const preset = document.getElementById('date-preset').value;
            const startInput = document.getElementById('start-date');
            const endInput = document.getElementById('end-date');
            const { startIso, endIso, note } = computeDateRange(preset, startInput.value, endInput.value);

            updateStatus('Filtering events...');

            try {
                const params = new URLSearchParams();
                librarySelected.forEach(l => params.append('library', l));
                typeSelected.forEach(t => params.append('type', t));
                if (search) params.append('search', search);
                if (searchMode) params.append('search_mode', searchMode);
                if (searchFields.length) params.append('search_fields', searchFields.join(','));
                if (startIso) params.append('start', startIso);
                if (endIso) params.append('end', endIso);

                const url = `/api/events?${params.toString()}`;
                const response = await fetch(url);
                const data = await response.json();
                filteredEvents = data.events;
                displayEvents(filteredEvents);
                const dateNote = note ? ` ${note}` : '';
                updateStatus(`Showing ${data.total} of ${allEvents.length} events${dateNote}`);
            } catch (error) {
                updateStatus('Error filtering events');
            }
        }

        function computeDateRange(preset, customStart, customEnd) {
            const today = new Date();
            const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            let start = null, end = null, note = '';
            const dow = today.getDay(); // 0=Sun..6=Sat
            if (preset === 'all') {
                return { startIso: '', endIso: '', note: '' };
            }
            if (preset === 'today') {
                start = new Date(today); end = new Date(today);
                note = `on ${toISO(start)}`;
            } else if (preset === 'tomorrow') {
                start = new Date(today); start.setDate(start.getDate()+1); end = new Date(start);
                note = `on ${toISO(start)}`;
            } else if (preset === 'next7') {
                start = new Date(today); end = new Date(today); end.setDate(end.getDate()+6);
                note = `from ${toISO(start)} to ${toISO(end)}`;
            } else if (preset === 'next14') {
                start = new Date(today); end = new Date(today); end.setDate(end.getDate()+13);
                note = `from ${toISO(start)} to ${toISO(end)}`;
            } else if (preset === 'thisweek') {
                // Sunday-Saturday
                start = new Date(today); start.setDate(start.getDate() - dow);
                end = new Date(start); end.setDate(start.getDate()+6);
                note = `this week (${toISO(start)} to ${toISO(end)})`;
            } else if (preset === 'weekend') {
                // Upcoming Fri-Sun (if already weekend, use current Fri-Sun)
                const daysUntilFri = (5 - dow + 7) % 7;
                start = new Date(today); start.setDate(start.getDate() + daysUntilFri);
                end = new Date(start); end.setDate(start.getDate() + 2);
                // If today is Sun (0), daysUntilFri=5 ⇒ next weekend; that's fine
                note = `weekend (${toISO(start)} to ${toISO(end)})`;
            } else if (preset === 'thismonth') {
                start = new Date(today.getFullYear(), today.getMonth(), 1);
                end = new Date(today.getFullYear(), today.getMonth()+1, 0);
                note = `this month (${toISO(start)} to ${toISO(end)})`;
            } else if (preset === 'custom') {
                const s = customStart || '';
                const e = customEnd || '';
                if (s && e) note = `from ${s} to ${e}`;
                else if (s) note = `on/after ${s}`;
                else if (e) note = `on/before ${e}`;
                return { startIso: s, endIso: e, note };
            }
            return { startIso: start ? toISO(start) : '', endIso: end ? toISO(end) : '', note };
        }

        function displayEvents(events) {
            const grid = document.getElementById('events-grid');

            if (events.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <span class="material-symbols-outlined text-4xl text-slate-400 mb-4 block">search_off</span>
                        <p class="text-slate-600 dark:text-slate-400">No events found matching your criteria.</p>
                    </div>`;
                return;
            }

            grid.innerHTML = events.map(event => {
                const ageGroup = event['Age Group'] || 'All Ages';
                const ageColor = getAgeGroupColor(ageGroup);

                return `
                    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 leading-tight pr-4">
                                ${escapeHtml(event.Title || 'Untitled Event')}
                            </h3>
                            <span class="px-3 py-1 bg-primary/10 text-primary text-xs font-medium rounded-full whitespace-nowrap">
                                ${escapeHtml(event.Library || 'Unknown')}
                            </span>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div class="flex items-center text-sm text-slate-600 dark:text-slate-400">
                                <span class="material-symbols-outlined text-lg mr-3 text-slate-400">event</span>
                                ${escapeHtml(event.Date || 'Date TBD')}
                            </div>
                            <div class="flex items-center text-sm text-slate-600 dark:text-slate-400">
                                <span class="material-symbols-outlined text-lg mr-3 text-slate-400">schedule</span>
                                ${escapeHtml(event.Time || 'Time TBD')}
                            </div>
                            <div class="flex items-center text-sm text-slate-600 dark:text-slate-400">
                                <span class="material-symbols-outlined text-lg mr-3 text-slate-400">location_on</span>
                                ${escapeHtml(event.Location || 'Location TBD')}
                            </div>
                            <div class="flex items-center text-sm text-slate-600 dark:text-slate-400">
                                <span class="material-symbols-outlined text-lg mr-3 text-slate-400">group</span>
                                <span class="px-2 py-1 ${ageColor} text-xs font-medium rounded">
                                    ${escapeHtml(ageGroup)}
                                </span>
                            </div>
                        </div>

                        ${event.Description && event.Description !== 'Not found' ?
                            `<p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-3">
                                ${escapeHtml(event.Description)}
                            </p>` : ''}

                        ${event.Link && event.Link !== 'N/A' && event.Link !== '' ?
                            `<div class="pt-3 border-t border-slate-200 dark:border-slate-700">
                                <a href="${escapeHtml(event.Link)}"
                                   target="_blank"
                                   rel="noopener"
                                   class="inline-flex items-center gap-2 text-primary hover:text-blue-700 font-medium text-sm transition-colors">
                                    <span>More Information</span>
                                    <span class="material-symbols-outlined text-sm">open_in_new</span>
                                </a>
                            </div>` : ''}
                    </div>`;
            }).join('');
        }

        function getAgeGroupColor(ageGroup) {
            const colors = {
                'Baby/Toddler': 'bg-pink-100 text-pink-700 dark:bg-pink-900 dark:text-pink-300',
                'Preschool/Early Elementary': 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300',
                'Elementary': 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
                'Middle School/Teen': 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
                'Teen/Young Adult': 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300',
                'Adult': 'bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300',
                'Family/All Ages': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300',
                'Kids': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300'
            };
            return colors[ageGroup] || 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300';
        }

        async function downloadICS() {
            const params = getCurrentFilterParams();
            window.location.href = `/api/ics?${params}`;
        }

        async function downloadPDF() {
            const params = getCurrentFilterParams();
            window.location.href = `/api/pdf?${params}`;
        }

        function getCurrentFilterParams() {
            const libraryCheckboxes = Array.from(document.querySelectorAll('input[name="library"]:checked'));
            const librarySelected = libraryCheckboxes
                .filter(cb => cb.value !== 'All')
                .map(cb => cb.value);
            const typeSelected = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => cb.value);
            const search = document.getElementById('search-input').value;
            const searchMode = document.getElementById('search-mode').value;
            const searchFields = Array.from(document.querySelectorAll('input[name="search-field"]:checked')).map(cb => cb.value);
            const preset = document.getElementById('date-preset').value;
            const startInput = document.getElementById('start-date');
            const endInput = document.getElementById('end-date');
            const { startIso, endIso } = computeDateRange(preset, startInput.value, endInput.value);

            const params = new URLSearchParams();
            librarySelected.forEach(l => params.append('library', l));
            typeSelected.forEach(t => params.append('type', t));
            if (search) params.append('search', search);
            if (searchMode) params.append('search_mode', searchMode);
            if (searchFields.length) params.append('search_fields', searchFields.join(','));
            if (startIso) params.append('start', startIso);
            if (endIso) params.append('end', endIso);

            return params.toString();
        }

        async function refreshData() {
            updateStatus('Starting scraper... This runs in the background.');
            const refreshBtn = document.getElementById('refresh-btn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = `
                <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                Refreshing...
            `;
            refreshBtn.disabled = true;

            try {
                const response = await fetch('/api/refresh', { method: 'POST' });
                const result = await response.json();

                if (response.ok && result.success) {
                    awaitingRefreshData = true;
                    startProgressPolling();
                    fetchProgress(true);
                    updateStatus('Scraper started. Tracking progress...');
                } else if (result.running) {
                    awaitingRefreshData = true;
                    startProgressPolling();
                    fetchProgress(true);
                    updateStatus('A scrape is already running. Tracking progress...');
                } else {
                    updateStatus('Error: ' + result.message);
                }
            } catch (error) {
                updateStatus('Error refreshing data: ' + error.message);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        }

        async function fetchProgress(force = false) {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                renderProgress(data);
                const state = (data?.summary?.state || 'idle').toLowerCase();
                const activeStates = ['running', 'queued', 'degraded', 'pending'];
                if (activeStates.includes(state) || awaitingRefreshData) {
                    startProgressPolling();
                } else if (!awaitingRefreshData) {
                    stopProgressPolling();
                }
            } catch (error) {
                updateStatus('Could not load progress');
            }
        }

        function renderProgress(data) {
            const summaryEl = document.getElementById('progress-summary');
            const gridEl = document.getElementById('progress-grid');
            const metaEl = document.getElementById('progress-meta');

            if (!data || !data.summary) {
                summaryEl.innerHTML = '<span class="text-xs text-slate-500 dark:text-slate-400">No progress available yet.</span>';
                gridEl.innerHTML = '';
                return;
            }

            const summary = data.summary || {};
            const sources = data.sources || {};
            const state = (summary.state || 'idle').toLowerCase();
            const updated = summary.updated_at || data.updated_at || '';
            const totalSources = summary.total_sources || Object.keys(sources).length || 0;
            const succeeded = summary.succeeded ?? 0;
            const failed = summary.failed ?? 0;
            const events = summary.events ?? '—';
            const message = summary.message || '';

            metaEl.textContent = `${stateLabel(state)}${updated ? ` • Updated ${new Date(updated).toLocaleTimeString()}` : ''}`;

            summaryEl.innerHTML = `
                <span class="${stateBadgeClass(state)}">${stateLabel(state)}</span>
                <span class="text-xs text-slate-600 dark:text-slate-400">Sources: ${succeeded}/${totalSources}${failed ? `, ${failed} failed` : ''}</span>
                <span class="text-xs text-slate-600 dark:text-slate-400">Events: ${events}</span>
                ${message ? `<span class="text-xs text-slate-500 dark:text-slate-400">${escapeHtml(message)}</span>` : ''}
            `;

            if (!totalSources) {
                gridEl.innerHTML = `<div class="text-sm text-slate-600 dark:text-slate-400">No runs yet.</div>`;
            } else {
                gridEl.innerHTML = Object.entries(sources).map(([name, payload]) => {
                    const srcState = (payload.state || 'pending').toLowerCase();
                    const count = payload.count ?? '—';
                    const msg = payload.message ? `<div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(payload.message)}</div>` : '';
                    return `
                        <div class="border border-slate-200 dark:border-slate-800 rounded-lg bg-white dark:bg-slate-900 p-3 shadow-sm">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-semibold text-slate-800 dark:text-slate-100">${escapeHtml(name)}</span>
                                <span class="${stateBadgeClass(srcState)}">${stateLabel(srcState)}</span>
                            </div>
                            <div class="text-xs text-slate-600 dark:text-slate-400">Events: ${count}</div>
                            ${msg}
                        </div>
                    `;
                }).join('');
            }

            const finishedStates = ['completed', 'completed_with_errors', 'error'];
            if (finishedStates.includes(state) && state !== lastProgressState) {
                awaitingRefreshData = false;
                loadEvents().then(() => {
                    document.getElementById('last-updated').textContent = new Date().toLocaleString();
                });
                updateStatus(state === 'error' ? 'Scrape failed. Showing last available data.' : 'Scrape finished. Reloaded events.');
                stopProgressPolling();
            }

            lastProgressState = state;
        }

        function startProgressPolling() {
            if (progressInterval) return;
            progressInterval = setInterval(() => fetchProgress(), 2500);
        }

        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function stateLabel(state) {
            const labels = {
                idle: 'Idle',
                pending: 'Pending',
                queued: 'Queued',
                running: 'Running',
                success: 'Done',
                completed: 'Completed',
                completed_with_errors: 'Completed (with issues)',
                degraded: 'Partial',
                error: 'Error'
            };
            return labels[state] || state;
        }

        function stateBadgeClass(state) {
            const base = "inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full font-semibold";
            const styles = {
                pending: `${base} bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200`,
                queued: `${base} bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200`,
                running: `${base} bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200`,
                success: `${base} bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200`,
                completed: `${base} bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200`,
                completed_with_errors: `${base} bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-200`,
                degraded: `${base} bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-200`,
                error: `${base} bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200`
            };
            return styles[state] || `${base} bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200`;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
